<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Excel File Upload Example</title>
        <!-- Include exceljs library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body>
        <p>version: 2</p>
        <input type="file" id="excelFileInput">
        <div id="output"></div>

        <script>

        const start_row = 3;

        const Moment = moment;

        document.getElementById('excelFileInput').addEventListener('change', handleFileUpload);

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                await readExcelFile(file);
            }
        }

        async function readExcelFile(file) {
            const workbook = new ExcelJS.Workbook();
            const new_wb= new ExcelJS.Workbook(); 
            const new_sheet = new_wb.addWorksheet('Workers');

            await workbook.xlsx.load(file);

            // Get the active worksheet
            const sheet = workbook.getWorksheet(1);

            const num_rows = sheet.rowCount - start_row;

            const rows = sheet.getRows(start_row, num_rows);

            const workers = new Set();
            rows.forEach(r=>workers.add(r.getCell(3).text));

            let output = '<br>';

            output += `<table class="border-separate border-spacing-2 border border-slate-400">
<thead>
<th>Worker</th>
<th>Time 1</th>
<th>Time 2</th>
</thead>
<tbody>
`;
            new_sheet.addRow(['Worker','Time1', 'Time2']);

            workers.forEach(w=>{
                const wr = rows.filter(r=>r.getCell(3)==w); 
                let tot = [new Moment('00:00', 'HH:mm'), new Moment('00:00', 'HH:mm')];
                output+='<tr>';
                wr.forEach(r=>{
                    let tott = 0;
                    if (r.getCell(2).value == '1')
                       tott = 0;
                    if (r.getCell(2).value == '2')
                       tott = 1;
 
                    const m = Moment(r.getCell(4).value.toISOString().substring(11,16), "HH:mm");
                    tot[tott].add(m.hours(), 'hours');
                    tot[tott].add(m.minutes(), 'minutes');
                });
                // console.log("Worker:", w, " => time1: ", tot1.format("HH:mm"), ", time2: ", tot2.format("HH:mm"));
                output += `<td>${w} </td> <td>${tot[0].format("HH:mm")}</td><td>${tot[1].format("HH:mm")}</td>`;
                output+='</tr>';
                new_sheet.addRow([w, tot[0].format("HH:mm"), tot[1].format("HH:mm")]);
            });

            output += `</tbody>

</table>`;

            // Display the results
            document.getElementById('output').innerHTML = output;

            const buffer = await new_wb.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = 'workers.xlsx';
            anchor.click();
            window.URL.revokeObjectURL(url);
        }
        </script>
    </body>
</html>

